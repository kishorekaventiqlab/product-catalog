{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Description": "Base Infrastructure Stack - S3 Buckets and Lambda Layer for Serverless Product Catalog (Deploy this FIRST)",
  "Parameters": {
    "ProjectName": {
      "Type": "String",
      "Default": "product-catalog",
      "Description": "Project name used for resource naming"
    },
    "Environment": {
      "Type": "String",
      "Default": "dev",
      "AllowedValues": ["dev", "staging", "prod"],
      "Description": "Environment name"
    }
  },
  "Resources": {
    "CloudFrontOriginAccessIdentity": {
      "Type": "AWS::CloudFront::CloudFrontOriginAccessIdentity",
      "Properties": {
        "CloudFrontOriginAccessIdentityConfig": {
          "Comment": {
            "Fn::Sub": "OAI for ${ProjectName} frontend"
          }
        }
      }
    },
    "FrontendS3Bucket": {
      "Type": "AWS::S3::Bucket",
      "Properties": {
        "BucketName": {
          "Fn::Sub": "${ProjectName}-frontend-${AWS::AccountId}-${Environment}"
        },
        "PublicAccessBlockConfiguration": {
          "BlockPublicAcls": true,
          "BlockPublicPolicy": true,
          "IgnorePublicAcls": true,
          "RestrictPublicBuckets": true
        },
        "VersioningConfiguration": {
          "Status": "Enabled"
        },
        "BucketEncryption": {
          "ServerSideEncryptionConfiguration": [
            {
              "ServerSideEncryptionByDefault": {
                "SSEAlgorithm": "AES256"
              }
            }
          ]
        },
        "LifecycleConfiguration": {
          "Rules": [
            {
              "Id": "DeleteOldVersions",
              "Status": "Enabled",
              "NoncurrentVersionExpirationInDays": 30
            }
          ]
        },
        "CorsConfiguration": {
          "CorsRules": [
            {
              "AllowedOrigins": ["*"],
              "AllowedMethods": ["GET", "HEAD"],
              "AllowedHeaders": ["*"],
              "MaxAge": 3000
            }
          ]
        },
        "Tags": [
          {
            "Key": "Project",
            "Value": {"Ref": "ProjectName"}
          },
          {
            "Key": "Environment",
            "Value": {"Ref": "Environment"}
          },
          {
            "Key": "Purpose",
            "Value": "Frontend Static Website Hosting"
          }
        ]
      }
    },
    "FrontendS3BucketPolicy": {
      "Type": "AWS::S3::BucketPolicy",
      "Properties": {
        "Bucket": {"Ref": "FrontendS3Bucket"},
        "PolicyDocument": {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Sid": "AllowCloudFrontOAI",
              "Effect": "Allow",
              "Principal": {
                "AWS": {
                  "Fn::Sub": "arn:aws:iam::cloudfront:user/CloudFront Origin Access Identity ${CloudFrontOriginAccessIdentity}"
                }
              },
              "Action": "s3:GetObject",
              "Resource": {
                "Fn::Sub": "${FrontendS3Bucket.Arn}/*"
              }
            }
          ]
        }
      }
    },
    "CloudFrontDistribution": {
      "Type": "AWS::CloudFront::Distribution",
      "Properties": {
        "DistributionConfig": {
          "Comment": {
            "Fn::Sub": "${ProjectName} Frontend Distribution"
          },
          "Enabled": true,
          "DefaultRootObject": "index.html",
          "HttpVersion": "http2",
          "PriceClass": "PriceClass_100",
          "Origins": [
            {
              "Id": "S3Origin",
              "DomainName": {
                "Fn::GetAtt": ["FrontendS3Bucket", "DomainName"]
              },
              "S3OriginConfig": {
                "OriginAccessIdentity": {
                  "Fn::Sub": "origin-access-identity/cloudfront/${CloudFrontOriginAccessIdentity}"
                }
              }
            }
          ],
          "DefaultCacheBehavior": {
            "TargetOriginId": "S3Origin",
            "ViewerProtocolPolicy": "redirect-to-https",
            "AllowedMethods": ["GET", "HEAD", "OPTIONS"],
            "CachedMethods": ["GET", "HEAD"],
            "Compress": true,
            "ForwardedValues": {
              "QueryString": false,
              "Cookies": {
                "Forward": "none"
              }
            },
            "MinTTL": 0,
            "DefaultTTL": 86400,
            "MaxTTL": 31536000
          },
          "CustomErrorResponses": [
            {
              "ErrorCode": 404,
              "ResponseCode": 200,
              "ResponsePagePath": "/index.html",
              "ErrorCachingMinTTL": 300
            },
            {
              "ErrorCode": 403,
              "ResponseCode": 200,
              "ResponsePagePath": "/index.html",
              "ErrorCachingMinTTL": 300
            }
          ],
          "ViewerCertificate": {
            "CloudFrontDefaultCertificate": true
          }
        },
        "Tags": [
          {
            "Key": "Project",
            "Value": {"Ref": "ProjectName"}
          },
          {
            "Key": "Environment",
            "Value": {"Ref": "Environment"}
          }
        ]
      }
    },
    "ArtifactS3Bucket": {
      "Type": "AWS::S3::Bucket",
      "Properties": {
        "BucketName": {
          "Fn::Sub": "${ProjectName}-artifacts-${AWS::AccountId}-${Environment}"
        },
        "VersioningConfiguration": {
          "Status": "Enabled"
        },
        "BucketEncryption": {
          "ServerSideEncryptionConfiguration": [
            {
              "ServerSideEncryptionByDefault": {
                "SSEAlgorithm": "AES256"
              }
            }
          ]
        },
        "LifecycleConfiguration": {
          "Rules": [
            {
              "Id": "DeleteOldArtifacts",
              "Status": "Enabled",
              "ExpirationInDays": 90,
              "NoncurrentVersionExpirationInDays": 30
            },
            {
              "Id": "TransitionToInfrequentAccess",
              "Status": "Enabled",
              "Transitions": [
                {
                  "TransitionInDays": 30,
                  "StorageClass": "STANDARD_IA"
                }
              ]
            }
          ]
        },
        "PublicAccessBlockConfiguration": {
          "BlockPublicAcls": true,
          "BlockPublicPolicy": true,
          "IgnorePublicAcls": true,
          "RestrictPublicBuckets": true
        },
        "Tags": [
          {
            "Key": "Project",
            "Value": {"Ref": "ProjectName"}
          },
          {
            "Key": "Environment",
            "Value": {"Ref": "Environment"}
          },
          {
            "Key": "Purpose",
            "Value": "CI/CD Pipeline Artifacts Storage"
          }
        ]
      }
    },
    "LambdaDeploymentBucket": {
      "Type": "AWS::S3::Bucket",
      "Properties": {
        "BucketName": {
          "Fn::Sub": "${ProjectName}-lambda-deployment-${AWS::AccountId}-${Environment}"
        },
        "VersioningConfiguration": {
          "Status": "Enabled"
        },
        "BucketEncryption": {
          "ServerSideEncryptionConfiguration": [
            {
              "ServerSideEncryptionByDefault": {
                "SSEAlgorithm": "AES256"
              }
            }
          ]
        },
        "LifecycleConfiguration": {
          "Rules": [
            {
              "Id": "DeleteOldLambdaPackages",
              "Status": "Enabled",
              "NoncurrentVersionExpirationInDays": 60
            }
          ]
        },
        "PublicAccessBlockConfiguration": {
          "BlockPublicAcls": true,
          "BlockPublicPolicy": true,
          "IgnorePublicAcls": true,
          "RestrictPublicBuckets": true
        },
        "Tags": [
          {
            "Key": "Project",
            "Value": {"Ref": "ProjectName"}
          },
          {
            "Key": "Environment",
            "Value": {"Ref": "Environment"}
          },
          {
            "Key": "Purpose",
            "Value": "Lambda Function Code Storage"
          }
        ]
      }
    }
  },
  "Outputs": {
    "FrontendS3BucketName": {
      "Description": "S3 bucket name for frontend hosting",
      "Value": {"Ref": "FrontendS3Bucket"},
      "Export": {
        "Name": {"Fn::Sub": "${AWS::StackName}-FrontendBucket"}
      }
    },
    "FrontendS3BucketArn": {
      "Description": "S3 bucket ARN for frontend",
      "Value": {"Fn::GetAtt": ["FrontendS3Bucket", "Arn"]},
      "Export": {
        "Name": {"Fn::Sub": "${AWS::StackName}-FrontendBucketArn"}
      }
    },
    "CloudFrontDistributionId": {
      "Description": "CloudFront Distribution ID",
      "Value": {"Ref": "CloudFrontDistribution"},
      "Export": {
        "Name": {"Fn::Sub": "${AWS::StackName}-CloudFrontDistributionId"}
      }
    },
    "CloudFrontDistributionDomainName": {
      "Description": "CloudFront Distribution Domain Name (use this URL to access your website)",
      "Value": {"Fn::GetAtt": ["CloudFrontDistribution", "DomainName"]},
      "Export": {
        "Name": {"Fn::Sub": "${AWS::StackName}-CloudFrontDomainName"}
      }
    },
    "WebsiteURL": {
      "Description": "Website URL",
      "Value": {
        "Fn::Sub": "https://${CloudFrontDistribution.DomainName}"
      },
      "Export": {
        "Name": {"Fn::Sub": "${AWS::StackName}-FrontendURL"}
      }
    },
    "ArtifactS3BucketName": {
      "Description": "S3 bucket name for pipeline artifacts",
      "Value": {"Ref": "ArtifactS3Bucket"},
      "Export": {
        "Name": {"Fn::Sub": "${AWS::StackName}-ArtifactBucket"}
      }
    },
    "ArtifactS3BucketArn": {
      "Description": "S3 bucket ARN for artifacts",
      "Value": {"Fn::GetAtt": ["ArtifactS3Bucket", "Arn"]},
      "Export": {
        "Name": {"Fn::Sub": "${AWS::StackName}-ArtifactBucketArn"}
      }
    },
    "LambdaDeploymentBucketName": {
      "Description": "S3 bucket name for Lambda deployment packages",
      "Value": {"Ref": "LambdaDeploymentBucket"},
      "Export": {
        "Name": {"Fn::Sub": "${AWS::StackName}-LambdaDeploymentBucket"}
      }
    },
    "LambdaDeploymentBucketArn": {
      "Description": "S3 bucket ARN for Lambda deployment",
      "Value": {"Fn::GetAtt": ["LambdaDeploymentBucket", "Arn"]},
      "Export": {
        "Name": {"Fn::Sub": "${AWS::StackName}-LambdaDeploymentBucketArn"}
      }
    }
  }
}
